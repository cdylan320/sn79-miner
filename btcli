#!/usr/bin/env bash
# btcli wrapper for bittensor Python API
set -e

# Force proper paths
export HOME="$HOME"
export BT_WALLET_PATH="$HOME/.bittensor/wallets"
mkdir -p "$BT_WALLET_PATH"

# Load environment variables from miner.env
SCRIPT_DIR="$(cd -- "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ENV_FILE="${SCRIPT_DIR}/miner.env"
if [[ -f "${ENV_FILE}" ]]; then
  # export all vars defined in the env file
  set -a
  source "${ENV_FILE}"
  set +a
fi

# Set additional environment variables needed for registration
export JSON_PATH="${JSON_PATH:-$HOME/sn79-miner/bittensor.json}"
export JSON_PASSWORD="${JSON_PASSWORD:-}"
export WALLET_NAME="${WALLET_NAME:-cold_draven}"
export HOTKEY_NAME="${HOTKEY_NAME:-default}"
export WALLET_PATH="${WALLET_PATH:-$HOME/.bittensor/wallets}"
export NETUID="${NETUID:-366}"
export NETWORK="${NETWORK:-test}"
export NUM_PROCESSES="${NUM_PROCESSES:-32}"
export USE_TORCH="${USE_TORCH:-1}"
export CUDA_VISIBLE_DEVICES="${CUDA_VISIBLE_DEVICES:-0}"

# Environment limits to avoid OpenBLAS thread spawn issues
export OPENBLAS_NUM_THREADS="${OPENBLAS_NUM_THREADS:-1}"
export OMP_NUM_THREADS="${OMP_NUM_THREADS:-1}"
export MKL_NUM_THREADS="${MKL_NUM_THREADS:-1}"
export BT_LOGGING="${BT_LOGGING:-DEBUG}"
export BT_PROGRESS="${BT_PROGRESS:-1}"

# Use btcli from project's virtual environment
export HOME="$HOME"
export BT_WALLET_PATH="$HOME/.bittensor/wallets"

# Activate the project's virtual environment (contains btcli)
SCRIPT_DIR="$(cd -- "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "${SCRIPT_DIR}/venv/bin/activate"

# For btcli v9.16.0, use proper commands
if [[ "$1" == "--version" || "$1" == "-v" ]]; then
    btcli --version
elif [[ "$1" == "subnet" && "$2" == "register" ]]; then
    # Use TAO payment method
    shift 2
    btcli s register "$@"
else
    btcli "$@"
fi

